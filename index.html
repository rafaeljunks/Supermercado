<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caixa Inteligente Turbo</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --highlight: #f39c12; --bg: #f4f7f6; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .market-header { background: var(--primary); color: white; padding: 12px; z-index: 10; }
        .market-select { background: #34495e; color: white; border: 2px solid #5d6d7e; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; }

        .budget-bar-container { background: #1a252f; padding: 5px 12px 10px; color: white; font-size: 0.7rem; }
        .budget-bg { background: #444; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        #budget-fill { background: var(--accent); height: 100%; width: 0%; transition: 0.5s; }

        .tabs { display: flex; background: #1a252f; color: white; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 0.65rem; opacity: 0.5; font-weight: 800; }
        .tab.active { opacity: 1; border-bottom: 4px solid var(--accent); }

        .content { flex: 1; display: none; overflow-y: auto; padding: 12px; }
        .content.active { display: block; }

        /* AJUSTE: LEITOR MAIOR */
        #reader-container { position: relative; width: 100%; height: 45vh; background: #000; border-radius: 12px; overflow: hidden; }
        #reader { width: 100% !important; height: 100% !important; }
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 120px; border: 2px solid var(--highlight); z-index: 10; border-radius: 12px; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); }

        .qty-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 10px 0; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .qty-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; }

        .card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--accent); }
        .done { text-decoration: line-through; opacity: 0.5; border-left-color: #bdc3c7 !important; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn-act { border: none; padding: 12px 5px; border-radius: 10px; color: white; font-weight: bold; font-size: 0.65rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        .footer-total { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        #price-alert { background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.8rem; border-left:4px solid var(--highlight); display:none; }
    </style>
</head>
<body>

<div class="market-header">
    <select id="current-market" class="market-select">
        <option value="Condor">Condor</option>
        <option value="Hipermais">Hipermais</option>
        <option value="Sams Club">Sams Club</option>
        <option value="Fort Atacadista">Fort Atacadista</option>
        <option value="Angeloni">Angeloni</option>
        <option value="Giassi">Giassi</option>
    </select>
</div>

<div class="budget-bar-container" onclick="setBudget()">
    <div style="display:flex; justify-content:space-between">
        <span>Gasto: <b id="spent-label">R$ 0,00</b></span>
        <span>Meta: <b id="budget-label">Definir</b></span>
    </div>
    <div class="budget-bg"><div id="budget-fill"></div></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">SCANNER</div>
    <div class="tab" onclick="switchTab(1)">LISTA</div>
    <div class="tab" onclick="switchTab(2)">CARRINHO</div>
    <div class="tab" onclick="switchTab(3)">HIST√ìRICO</div>
</div>

<div id="tab-scan" class="content active">
    <div id="reader-container"><div id="reader"></div><div class="scan-overlay"></div></div>
    
    <div class="qty-selector">
        <button class="qty-btn" onclick="changeQty(-1)">-</button>
        <span style="font-size: 1.5rem; font-weight: bold;" id="current-qty">1</span>
        <button class="qty-btn" onclick="changeQty(1)">+</button>
    </div>

    <div id="price-alert"></div>

    <div class="btn-group">
        <button onclick="tirarFotoPreco()" class="btn-act" style="background:var(--highlight)">üì∏<span>FOTO PRE√áO</span></button>
        <button onclick="entradaManual()" class="btn-act" style="background:var(--accent)">‚å®Ô∏è<span>DIGITAR</span></button>
        <button onclick="reiniciar()" class="btn-act" style="background:var(--primary)">üîÑ<span>LIMPAR</span></button>
    </div>
</div>

<div id="tab-lista" class="content">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="todo-input" placeholder="O que precisa comprar?" style="flex:1; padding:12px; border-radius:8px; border:1px solid #ddd;">
        <button onclick="addTodo()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold;">+</button>
    </div>
    <div id="todo-list"></div>
</div>

<div id="tab-carrinho" class="content">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <button onclick="shareWhatsApp()" style="background:#25D366; color:white; border:none; padding:8px 12px; border-radius:5px; font-weight:bold; font-size:0.6rem;">üì≤ WHATSAPP</button>
        <button onclick="finalizarCompra()" style="background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:5px; font-weight:bold; font-size:0.6rem;">üèÅ FINALIZAR</button>
    </div>
    <div id="lista-atual"></div>
    <div class="footer-total">
        <b style="color:#7f8c8d">TOTAL</b>
        <b id="total-val" style="font-size: 1.8rem; color: var(--accent);">R$ 0,00</b>
    </div>
</div>

<div id="tab-historico" class="content">
    <div id="history-data"></div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let scanner;
    let items = JSON.parse(localStorage.getItem('v_carrinho')) || [];
    let history = JSON.parse(localStorage.getItem('v_precos')) || {};
    let names = JSON.parse(localStorage.getItem('v_nomes')) || {}; // Novo: Banco de nomes
    let todos = JSON.parse(localStorage.getItem('v_todos')) || [];
    let budget = localStorage.getItem('v_budget') || 0;
    let lastBarcode = "";
    let currentQty = 1;

    async function init() {
        scanner = new Html5Qrcode("reader");
        render();
        startScanner();
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    function startScanner() {
        scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 280, height: 120 } }, (text) => {
            if (text !== lastBarcode) {
                lastBarcode = text;
                vibrar(100);
                checkHistory(text);
            }
        });
    }

    function checkHistory(barcode) {
        const box = document.getElementById('price-alert');
        let prodName = names[barcode] || "Produto novo";
        
        if(history[barcode]) {
            let info = history[barcode].map(h => `<br>‚Ä¢ ${h.market}: R$ ${h.price.toFixed(2)}`).join('');
            box.innerHTML = `üîé <b>${prodName}:</b> ${info}`;
            box.style.display = 'block';
        } else {
            box.innerHTML = `üè∑Ô∏è ${prodName} detectado!`;
            box.style.display = 'block';
        }
    }

    function addItem(price) {
        const market = document.getElementById('current-market').value;
        
        // AJUSTE: PERGUNTA O NOME SE FOR NOVO
        if(lastBarcode && !names[lastBarcode]) {
            let n = prompt("Nome do produto:");
            names[lastBarcode] = n || "Item";
            localStorage.setItem('v_nomes', JSON.stringify(names));
        }

        let nomeItem = lastBarcode ? names[lastBarcode] : "Item Manual";
        items.unshift({ id: Date.now(), market, price, qty: currentQty, name: nomeItem });
        
        if(lastBarcode) {
            if(!history[lastBarcode]) history[lastBarcode] = [];
            let mIdx = history[lastBarcode].findIndex(h => h.market === market);
            if(mIdx > -1) history[lastBarcode][mIdx].price = price;
            else history[lastBarcode].push({ market, price });
        }

        // Tenta marcar na lista se o nome bater
        let matchTodo = todos.find(t => !t.done && nomeItem.toLowerCase().includes(t.txt.toLowerCase()));
        if(matchTodo) matchTodo.done = true;
        else {
            let nextTodo = todos.find(t => !t.done);
            if(nextTodo) nextTodo.done = true;
        }

        save();
        vibrar([50, 50]);
        currentQty = 1; document.getElementById('current-qty').innerText = "1";
        document.getElementById('price-alert').style.display = 'none';
    }

    function finalizarCompra() {
        if(confirm("Finalizar compra?")) {
            items = [];
            todos = todos.filter(t => !t.done);
            save();
            switchTab(0);
        }
    }

    function addTodo() {
        const input = document.getElementById('todo-input');
        if(input.value) {
            todos.push({ txt: input.value, done: false });
            input.value = "";
            save();
        }
    }

    function save() {
        localStorage.setItem('v_carrinho', JSON.stringify(items));
        localStorage.setItem('v_precos', JSON.stringify(history));
        localStorage.setItem('v_todos', JSON.stringify(todos));
        render();
    }

    function render() {
        let total = 0;
        document.getElementById('lista-atual').innerHTML = items.map(i => {
            total += (i.price * i.qty);
            return `<div class="card">
                <div><small>${i.market}</small><br><b>${i.qty}x ${i.name || 'Item'}</b></div>
                <div style="text-align:right"><b>R$ ${(i.price * i.qty).toFixed(2)}</b><br>
                <button onclick="remover(${i.id})" style="border:none; background:none; color:red; font-size:0.7rem">Remover</button></div>
            </div>`;
        }).join('');
        
        document.getElementById('total-val').innerText = "R$ " + total.toFixed(2);
        document.getElementById('spent-label').innerText = "R$ " + total.toFixed(2);
        
        if(budget > 0) {
            document.getElementById('budget-label').innerText = "R$ " + parseFloat(budget).toFixed(2);
            let percent = Math.min((total / budget) * 100, 100);
            const fill = document.getElementById('budget-fill');
            fill.style.width = percent + "%";
            fill.style.background = percent > 90 ? "var(--danger)" : (percent > 70 ? "var(--highlight)" : "var(--accent)");
        }

        document.getElementById('todo-list').innerHTML = todos.map((t, idx) => `
            <div class="card ${t.done ? 'done' : ''}">
                <span>${t.txt}</span>
                <input type="checkbox" ${t.done ? 'checked' : ''} onclick="todos[${idx}].done = !todos[${idx}].done; save();">
            </div>
        `).join('');

        document.getElementById('history-data').innerHTML = Object.keys(history).map(code => `
            <div class="card" style="flex-direction:column; align-items:flex-start; border-left-color:var(--highlight)">
                <small style="color:#999">${names[code] || 'Sem nome'} (${code})</small>
                ${history[code].map(p => `<div style="width:100%; display:flex; justify-content:space-between"><span>${p.market}</span><b>R$ ${p.price.toFixed(2)}</b></div>`).join('')}
            </div>
        `).join('');
    }

    async function tirarFotoPreco() {
        const video = document.querySelector('video');
        const canvas = document.getElementById('hidden-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; canvas.height = 320;
        ctx.drawImage(video, video.videoWidth/2-320, video.videoHeight/2-160, 640, 320, 0, 0, 640, 320);
        try {
            const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'por');
            const match = text.match(/\d+,\d{2}/);
            if (match) addItem(parseFloat(match[0].replace(',', '.')));
            else entradaManual();
        } catch (e) { entradaManual(); }
    }

    function changeQty(v) { currentQty = Math.max(1, currentQty + v); document.getElementById('current-qty').innerText = currentQty; }
    function setBudget() { let b = prompt("Meta:"); if(b) { budget = b; localStorage.setItem('v_budget', b); render(); } }
    function remover(id) { items = items.filter(i => i.id !== id); save(); }
    function vibrar(p) { if(navigator.vibrate) navigator.vibrate(p); }
    function reiniciar() { lastBarcode = ""; document.getElementById('price-alert').style.display = 'none'; }
    function entradaManual() { 
        let n = prompt("Nome do produto:");
        let p = prompt("Pre√ßo:"); 
        if(p) {
            if(n) { names["manual_"+Date.now()] = n; }
            addItem(parseFloat(p.replace(',','.'))); 
        }
    }
    function shareWhatsApp() {
        let txt = `üõí *Compra no ${document.getElementById('current-market').value}*\n\n`;
        items.forEach(i => { txt += `‚Ä¢ ${i.qty}x ${i.name || 'Item'}: R$ ${(i.price * i.qty).toFixed(2)}\n`; });
        txt += `\nüí∞ *TOTAL: ${document.getElementById('total-val').innerText}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
    }

    window.onload = init;
</script>
</body>
</html>

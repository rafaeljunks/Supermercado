<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caixa PRO Ultra | Joinville</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root { 
            --primary: #0f172a; 
            --accent: #10b981; 
            --highlight: #f59e0b; 
            --bg: #f8fafc; 
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; background: var(--bg); height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; color: var(--text-main);
        }
        
        /* HEADER */
        .market-header { background: var(--primary); padding: 10px 15px; }
        .market-select { 
            background: #1e293b; color: white; border: 1px solid #334155; 
            padding: 10px; border-radius: 10px; width: 100%; font-size: 1rem; font-weight: 600; outline: none;
        }

        .budget-bar-container { background: #020617; padding: 8px 15px; color: white; }
        .budget-info { display:flex; justify-content:space-between; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; }
        .budget-bg { background: #1e293b; height: 8px; border-radius: 4px; overflow: hidden; }
        #budget-fill { background: var(--accent); height: 100%; width: 0%; transition: 0.6s cubic-bezier(0.1, 0.7, 1.0, 0.1); }

        /* TABS */
        .tabs { display: flex; background: #020617; }
        .tab { flex: 1; padding: 15px 5px; text-align: center; font-size: 0.7rem; opacity: 0.5; font-weight: 800; color: white; letter-spacing: 0.5px; }
        .tab.active { opacity: 1; border-bottom: 4px solid var(--accent); color: var(--accent); }

        .content { flex: 1; display: none; overflow-y: auto; padding: 10px; }
        .content.active { display: block; }

        /* SCANNER */
        #reader-container { position: relative; width: 100%; height: 32vh; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .scan-overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 75%; height: 80px; border: 3px solid var(--accent); z-index: 10; 
            border-radius: 12px; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); 
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: rgba(16, 185, 129, 0.5);
            top: 50%; animation: moveScan 2s infinite linear;
        }
        @keyframes moveScan { 0% { top: 30%; } 50% { top: 70%; } 100% { top: 30%; } }

        /* CONTROLES */
        .qty-selector { 
            display: flex; justify-content: center; align-items: center; gap: 20px; 
            margin: 10px 0; background: white; padding: 8px; border-radius: 12px; 
        }
        .qty-btn { 
            background: var(--primary); color: white; border: none; width: 40px; height: 40px; 
            border-radius: 10px; font-size: 1.4rem; font-weight: bold;
        }
        #current-qty { font-size: 1.4rem; font-weight: 800; min-width: 30px; text-align: center; }

        /* CARDS COMPACTOS */
        .card { 
            background: white; padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 4px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .card b { font-size: 0.9rem; display: block; color: var(--primary); }
        .card small { color: var(--text-sub); font-size: 0.7rem; font-weight: 600; }
        
        .price-tag { color: var(--accent); font-weight: 800; font-size: 1.05rem; cursor: pointer; border-bottom: 1px dashed #d1fae5; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn-act { 
            border: none; padding: 10px 5px; border-radius: 12px; color: white; 
            font-weight: 700; font-size: 0.6rem; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }

        /* ABA LISTA ESPEC√çFICO */
        .todo-item-text { flex: 1; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
        .btn-del-todo { color: var(--danger); border: none; background: none; font-weight: 800; padding: 5px 10px; font-size: 0.9rem; }

        /* FOOTER */
        .footer-total { 
            position: sticky; bottom: 0; background: white; padding: 12px 18px; 
            border-top: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; 
        }
        .footer-total b#total-val { font-size: 1.8rem; color: var(--accent); font-weight: 800; }

        #price-alert { 
            background:#ecfdf5; padding:10px; border-radius:10px; margin-bottom:10px; 
            font-size:0.8rem; border-left:4px solid var(--accent); display:none; color: #065f46; 
        }

        input[type="text"] { 
            width: 100%; box-sizing: border-box; padding: 12px; border-radius: 10px; 
            border: 2px solid #e2e8f0; font-size: 0.85rem;
        }

        .done { opacity: 0.4; filter: grayscale(1); border-left-color: #cbd5e1 !important; }
        .done .todo-item-text { text-decoration: line-through; }
    </style>
</head>
<body>

<div class="market-header">
    <select id="current-market" class="market-select">
        <option value="Condor">Condor</option>
        <option value="Hipermais">Hipermais</option>
        <option value="Sams Club">Sams Club</option>
        <option value="Fort Atacadista">Fort Atacadista</option>
        <option value="Angeloni">Angeloni</option>
        <option value="Giassi">Giassi</option>
    </select>
</div>

<div class="budget-bar-container" onclick="setBudget()">
    <div class="budget-info">
        <span>Gasto: <b id="spent-label">R$ 0,00</b></span>
        <span>Meta: <b id="budget-label">Definir</b></span>
    </div>
    <div class="budget-bg"><div id="budget-fill"></div></div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">SCANNER</div>
    <div class="tab" onclick="switchTab(1)">LISTA</div>
    <div class="tab" onclick="switchTab(2)">CARRINHO</div>
    <div class="tab" onclick="switchTab(3)">DADOS</div>
</div>

<div id="tab-scan" class="content active">
    <div id="reader-container">
        <div id="reader"></div>
        <div class="scan-overlay"><div class="scan-line"></div></div>
    </div>
    
    <div class="qty-selector">
        <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
        <span id="current-qty">1</span>
        <button class="qty-btn" onclick="changeQty(1)">+</button>
    </div>

    <div id="price-alert"></div>

    <div class="btn-group">
        <button onclick="tirarFotoPreco()" class="btn-act" style="background:var(--highlight)">üì∏<span>PRE√áO</span></button>
        <button onclick="entradaManual()" class="btn-act" style="background:var(--accent)">‚å®Ô∏è<span>DIGITAR</span></button>
        <button onclick="reiniciar()" class="btn-act" style="background:var(--primary)">üîÑ<span>LIMPAR</span></button>
    </div>
</div>

<div id="tab-lista" class="content">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input type="text" id="todo-input" placeholder="O que comprar?">
        <button onclick="addTodo()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:10px; font-weight:bold; font-size:1.1rem">+</button>
    </div>
    <div id="todo-list"></div>
</div>

<div id="tab-carrinho" class="content">
    <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button onclick="shareWhatsApp()" style="flex:1; background:#25D366; color:white; border:none; padding:10px; border-radius:10px; font-weight:bold; font-size:0.75rem;">üì≤ WHATSAPP</button>
        <button onclick="finalizarCompra()" style="flex:1; background:var(--accent); color:white; border:none; padding:10px; border-radius:10px; font-weight:bold; font-size:0.75rem;">üèÅ FINALIZAR</button>
    </div>
    <div id="lista-atual"></div>
    <div class="footer-total">
        <b style="color:var(--text-sub); font-size: 0.8rem;">TOTAL</b>
        <b id="total-val">R$ 0,00</b>
    </div>
</div>

<div id="tab-dados" class="content">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:15px;">
        <button onclick="exportarDados()" style="padding:12px; border-radius:10px; background:#334155; color:white; border:none; font-weight:bold; font-size:0.75rem">üíæ BACKUP</button>
        <button onclick="document.getElementById('import-file').click()" style="padding:12px; border-radius:10px; background:#334155; color:white; border:none; font-weight:bold; font-size:0.75rem">üìÇ IMPORTAR</button>
        <input type="file" id="import-file" style="display:none" onchange="importarDados(this)">
    </div>
    <h3 style="margin: 0 0 10px 0; font-size: 0.9rem">Hist√≥rico de Pre√ßos</h3>
    <div id="history-data"></div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let scanner;
    let items = JSON.parse(localStorage.getItem('v_carrinho')) || [];
    let history = JSON.parse(localStorage.getItem('v_precos')) || {};
    let names = JSON.parse(localStorage.getItem('v_nomes')) || {};
    let todos = JSON.parse(localStorage.getItem('v_todos')) || [];
    let budget = localStorage.getItem('v_budget') || 0;
    let lastBarcode = "";
    let currentQty = 1;

    async function init() {
        scanner = new Html5Qrcode("reader");
        render();
        startScanner();
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    function startScanner() {
        scanner.start({ facingMode: "environment" }, { fps: 30, qrbox: { width: 280, height: 100 }, aspectRatio: 1.777778 }, 
            (text) => { if (text !== lastBarcode) { lastBarcode = text; vibrar(100); checkHistory(text); } }
        ).catch(err => console.error(err));
    }

    function checkHistory(barcode) {
        const box = document.getElementById('price-alert');
        let prodName = names[barcode] || "Produto novo";
        if(history[barcode]) {
            let info = history[barcode].map(h => `<br>‚Ä¢ ${h.market}: R$ ${h.price.toFixed(2)}`).join('');
            box.innerHTML = `üîé <b>${prodName}:</b> ${info}`;
            box.style.display = 'block';
        } else {
            box.innerHTML = `üè∑Ô∏è ${prodName} detectado!`;
            box.style.display = 'block';
        }
    }

    function addItem(price) {
        const market = document.getElementById('current-market').value;
        if(lastBarcode && !names[lastBarcode]) {
            let n = prompt("Nome do produto:");
            names[lastBarcode] = n || "Item " + lastBarcode.slice(-4);
            localStorage.setItem('v_nomes', JSON.stringify(names));
        }
        let nomeItem = lastBarcode ? names[lastBarcode] : "Manual";
        items.unshift({ id: Date.now(), market, price, qty: currentQty, name: nomeItem, barcode: lastBarcode });
        updateHistory(lastBarcode, market, price);
        save();
        vibrar([50, 50]);
        currentQty = 1; document.getElementById('current-qty').innerText = "1";
        document.getElementById('price-alert').style.display = 'none';
    }

    function updateHistory(barcode, market, price) {
        if(!barcode) return;
        if(!history[barcode]) history[barcode] = [];
        let mIdx = history[barcode].findIndex(h => h.market === market);
        if(mIdx > -1) history[barcode][mIdx].price = price;
        else history[barcode].push({ market, price });
    }

    function editarPreco(itemId) {
        let item = items.find(i => i.id === itemId);
        let novo = prompt(`Editar pre√ßo de "${item.name}":`, item.price);
        if (novo !== null && !isNaN(parseFloat(novo))) {
            item.price = parseFloat(novo.replace(',', '.'));
            updateHistory(item.barcode, item.market, item.price);
            save();
        }
    }

    /* FUN√á√ïES NOVAS PARA ABA LISTA */
    function editarTodo(idx) {
        let novo = prompt("Editar item:", todos[idx].txt);
        if(novo) { todos[idx].txt = novo; save(); }
    }
    function removerTodo(idx) {
        if(confirm("Remover da lista?")) { todos.splice(idx, 1); save(); }
    }

    function save() {
        localStorage.setItem('v_carrinho', JSON.stringify(items));
        localStorage.setItem('v_precos', JSON.stringify(history));
        localStorage.setItem('v_nomes', JSON.stringify(names));
        localStorage.setItem('v_todos', JSON.stringify(todos));
        render();
    }

    function render() {
        let total = 0;
        // Render Carrinho
        document.getElementById('lista-atual').innerHTML = items.map(i => {
            total += (i.price * i.qty);
            return `<div class="card">
                <div><small>${i.market}</small><br><b>${i.qty}x ${i.name}</b></div>
                <div style="text-align:right">
                    <div class="price-tag" onclick="editarPreco(${i.id})">R$ ${(i.price * i.qty).toFixed(2)}</div>
                    <button onclick="remover(${i.id})" style="border:none; background:none; color:var(--danger); font-size:0.65rem; font-weight:bold; margin-top:5px;">EXCLUIR</button>
                </div>
            </div>`;
        }).join('');
        
        document.getElementById('total-val').innerText = "R$ " + total.toFixed(2);
        document.getElementById('spent-label').innerText = "R$ " + total.toFixed(2);
        
        if(budget > 0) {
            let percent = Math.min((total / budget) * 100, 100);
            document.getElementById('budget-fill').style.width = percent + "%";
            document.getElementById('budget-label').innerText = "R$ " + parseFloat(budget).toFixed(2);
        }

        // Render Lista com Editar e Excluir
        document.getElementById('todo-list').innerHTML = todos.map((t, idx) => `
            <div class="card ${t.done ? 'done' : ''}" style="border-left-color: ${t.done ? '#cbd5e1' : 'var(--highlight)'}">
                <span class="todo-item-text" onclick="editarTodo(${idx})">${t.txt}</span>
                <div style="display:flex; align-items:center; gap:8px">
                    <input type="checkbox" style="width:20px; height:20px" ${t.done ? 'checked' : ''} onclick="todos[${idx}].done = !todos[${idx}].done; save();">
                    <button class="btn-del-todo" onclick="removerTodo(${idx})">‚úï</button>
                </div>
            </div>
        `).join('');

        // Render Dados (Hist√≥rico)
        document.getElementById('history-data').innerHTML = Object.keys(history).map(code => `
            <div class="card" style="flex-direction:column; align-items:flex-start; border-left-color:#334155">
                <small style="margin-bottom:3px">${names[code] || code}</small>
                ${history[code].map(p => `<div style="width:100%; display:flex; justify-content:space-between; margin-top:1px; font-size:0.7rem"><span>${p.market}</span><b style="color:var(--accent)">R$ ${p.price.toFixed(2)}</b></div>`).join('')}
            </div>
        `).join('');
    }

    async function tirarFotoPreco() {
        const video = document.querySelector('video');
        const canvas = document.getElementById('hidden-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; canvas.height = 320;
        ctx.drawImage(video, video.videoWidth/2-320, video.videoHeight/2-160, 640, 320, 0, 0, 640, 320);
        try {
            const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'por');
            const match = text.match(/\d+,\d{2}/);
            if (match) addItem(parseFloat(match[0].replace(',', '.')));
            else entradaManual();
        } catch (e) { entradaManual(); }
    }

    function changeQty(v) { currentQty = Math.max(1, currentQty + v); document.getElementById('current-qty').innerText = currentQty; }
    function setBudget() { let b = prompt("Meta:"); if(b) { budget = b; localStorage.setItem('v_budget', b); render(); } }
    function remover(id) { if(confirm("Remover?")) { items = items.filter(i => i.id !== id); save(); } }
    function addTodo() { const i = document.getElementById('todo-input'); if(i.value) { todos.push({txt: i.value, done:false}); i.value=""; save(); } }
    function vibrar(p) { if(navigator.vibrate) navigator.vibrate(p); }
    function reiniciar() { lastBarcode = ""; document.getElementById('price-alert').style.display = 'none'; }
    function entradaManual() { 
        let n = prompt("Nome:"); let p = prompt("Pre√ßo:"); 
        if(p) { if(n) { let id = "man_"+Date.now(); names[id] = n; lastBarcode = id; } addItem(parseFloat(p.replace(',','.'))); }
    }
    function finalizarCompra() { if(confirm("Finalizar?")) { items = []; todos = todos.filter(t => !t.done); save(); switchTab(0); } }
    function shareWhatsApp() {
        let txt = `üõí *Compra no ${document.getElementById('current-market').value}*\n\n`;
        items.forEach(i => { txt += `‚Ä¢ ${i.qty}x ${i.name}: R$ ${(i.price * i.qty).toFixed(2)}\n`; });
        txt += `\nüí∞ *TOTAL: ${document.getElementById('total-val').innerText}*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
    }
    function exportarDados() {
        const d = { history, names, budget };
        const blob = new Blob([JSON.stringify(d)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_caixa.json`; a.click();
    }
    function importarDados(input) {
        const r = new FileReader();
        r.onload = function() {
            const d = JSON.parse(r.result);
            history = d.history || {}; names = d.names || {}; save(); alert("Importado!");
        };
        r.readAsText(input.files[0]);
    }

    window.onload = init;
</script>
</body>
</html>

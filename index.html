<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caixa de Bolso Inteligente</title>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root { --primary: #27ae60; --secondary: #2980b9; --danger: #e74c3c; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f0f2f5; color: var(--dark); }
        
        header { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* C√¢mera e Mira */
        #camera-viewport { position: relative; width: 100%; height: 45vh; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .mira { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 260px; height: 130px; border: 3px solid var(--primary);
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.4); border-radius: 12px;
            z-index: 10; pointer-events: none;
        }
        .mira::before { content: "FOQUE NO PRE√áO"; position: absolute; top: -25px; left: 0; width: 100%; text-align: center; font-size: 12px; color: var(--primary); font-weight: bold; }

        /* Controles */
        .controls { display: flex; justify-content: space-around; padding: 20px; background: white; margin-top: -20px; border-radius: 20px 20px 0 0; position: relative; z-index: 20; }
        .btn { border: none; border-radius: 50%; width: 65px; height: 65px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-scan { background: var(--primary); }
        .btn-barcode { background: var(--secondary); }
        .btn-clear { background: var(--danger); width: 45px; height: 45px; border-radius: 10px; }

        /* Lista de Compras */
        .carrinho { padding: 15px; padding-bottom: 100px; max-height: 35vh; overflow-y: auto; }
        .item-row { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Rodap√© Fixo */
        .footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 20px; box-sizing: border-box; border-top: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; z-index: 30; }
        .total-label { font-size: 14px; color: #666; }
        .total-value { font-size: 26px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<header>MEU CAIXA DE BOLSO</header>

<div id="camera-viewport">
    <video id="video" autoplay playsinline></video>
    <div class="mira"></div>
    <canvas id="crop-canvas" style="display:none;"></canvas>
</div>

<div class="controls">
    <button class="btn btn-clear" onclick="limparTudo()" title="Limpar Tudo">üóëÔ∏è</button>
    <button class="btn btn-scan" onclick="lerPreco()" id="btn-main">üì∏<br><small>PRE√áO</small></button>
    <button class="btn btn-barcode" onclick="lerCodigoBarras()">üè∑Ô∏è<br><small>BARRAS</small></button>
</div>

<div class="carrinho" id="carrinho-lista">
    </div>

<div class="footer">
    <div>
        <span class="total-label">VALOR TOTAL</span><br>
        <span class="total-value" id="total-geral">R$ 0,00</span>
    </div>
    <button onclick="window.print()" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">Gerar Lista</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('carrinho')) || [];
    const video = document.getElementById('video');

    // Inicializar C√¢mera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => video.srcObject = stream);

    function atualizarTela() {
        const lista = document.getElementById('carrinho-lista');
        lista.innerHTML = '';
        let soma = 0;
        db.forEach((item, index) => {
            soma += item.preco;
            lista.innerHTML += `
                <div class="item-row">
                    <span>${item.nome}</span>
                    <strong>R$ ${item.preco.toFixed(2).replace('.',',')}</strong>
                </div>
            `;
        });
        document.getElementById('total-geral').innerText = `R$ ${soma.toFixed(2).replace('.',',')}`;
        localStorage.setItem('carrinho', JSON.stringify(db));
    }

    // FUN√á√ÉO 1: LER PRE√áO (OCR)
    async function lerPreco() {
        const btn = document.getElementById('btn-main');
        btn.style.opacity = '0.5';
        btn.innerText = "‚è≥";

        const canvas = document.getElementById('crop-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 300; canvas.height = 150;
        
        // Corta a imagem da mira
        ctx.drawImage(video, video.videoWidth/2 - 150, video.videoHeight/2 - 75, 300, 150, 0, 0, 300, 150);
        
        try {
            const result = await Tesseract.recognize(canvas.toDataURL(), 'por');
            const match = result.data.text.match(/\d+,\d{2}/);
            
            if (match) {
                const valor = parseFloat(match[0].replace(',', '.'));
                db.push({ nome: "Item " + (db.length + 1), preco: valor });
                atualizarTela();
            } else {
                alert("Pre√ßo n√£o encontrado. Tente focar melhor!");
            }
        } catch (e) { alert("Erro ao processar imagem."); }
        
        btn.style.opacity = '1';
        btn.innerHTML = "üì∏<br><small>PRE√áO</small>";
    }

    // FUN√á√ÉO 2: LER C√ìDIGO DE BARRAS (OPCIONAL)
    function lerCodigoBarras() {
        Quagga.init({
            inputStream: { type: "LiveStream", target: video },
            decoder: { readers: ["ean_reader"] }
        }, (err) => {
            if (!err) Quagga.start();
        });

        Quagga.onDetected((data) => {
            alert("Produto identificado: " + data.codeResult.code);
            Quagga.stop();
            lerPreco(); // Ap√≥s identificar o produto, pede para ler o pre√ßo
        });
    }

    function limparTudo() {
        if(confirm("Deseja esvaziar o carrinho?")) {
            db = [];
            atualizarTela();
        }
    }

    atualizarTela(); // Carrega dados salvos
</script>

</body>
</html>

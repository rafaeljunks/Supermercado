<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Caixa Pro</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --highlight: #f39c12; --bg: #f4f7f6; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header e Seletor */
        .market-header { background: var(--primary); color: white; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10; }
        .market-select { background: #34495e; color: white; border: 2px solid #5d6d7e; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; font-size: 1rem; appearance: none; }

        /* Abas */
        .tabs { display: flex; background: #1a252f; color: white; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 0.75rem; opacity: 0.5; font-weight: 800; letter-spacing: 1px; transition: 0.3s; }
        .tab.active { opacity: 1; border-bottom: 4px solid var(--accent); background: rgba(39, 174, 96, 0.1); }

        .content { flex: 1; display: none; overflow-y: auto; padding: 12px; }
        .content.active { display: block; }

        /* √Årea da C√¢mera */
        #reader-container { position: relative; width: 100%; height: 32vh; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 2px solid #ddd; }
        #reader { width: 100% !important; height: 100% !important; }
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 100px; border: 2px solid var(--highlight); z-index: 10; border-radius: 12px; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.6); }
        .scan-overlay::before { content: "FOQUE O C√ìDIGO"; position: absolute; top: -25px; width: 100%; text-align: center; color: var(--highlight); font-size: 10px; font-weight: bold; }

        /* Alertas e Cards */
        #price-alert { background: #fff3cd; border-left: 6px solid #ffc107; padding: 15px; margin: 10px 0; display: none; font-size: 0.9rem; border-radius: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .card { background: white; padding: 14px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); border-left: 5px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .market-tag { font-size: 9px; padding: 3px 7px; border-radius: 5px; background: #eee; color: #444; font-weight: 800; text-transform: uppercase; margin-right: 8px; }

        /* Bot√µes */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-act { border: none; padding: 15px 5px; border-radius: 10px; color: white; font-weight: bold; font-size: 0.7rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .btn-act:active { transform: translateY(3px); box-shadow: none; }

        .footer-total { position: sticky; bottom: 0; background: white; padding: 18px; border-top: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; margin: 0 -12px; }
    </style>
</head>
<body>

<div class="market-header">
    <select id="current-market" class="market-select">
        <option value="Condor">Condor</option>
        <option value="Hipermais">Hipermais</option>
        <option value="Sams Club">Sams Club</option>
        <option value="Fort Atacadista">Fort Atacadista</option>
        <option value="Angeloni">Angeloni</option>
        <option value="Giassi">Giassi</option>
    </select>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">SCANNER</div>
    <div class="tab" onclick="switchTab(1)">CARRINHO</div>
    <div class="tab" onclick="switchTab(2)">HIST√ìRICO</div>
</div>

<div id="tab-scan" class="content active">
    <div id="reader-container">
        <div id="reader"></div>
        <div class="scan-overlay"></div>
    </div>
    
    <div id="price-alert"></div>

    <div class="btn-group">
        <button onclick="tirarFotoPreco()" class="btn-act" style="background:var(--highlight)">üì∏<span>FOTO PRE√áO</span></button>
        <button onclick="entradaManual()" class="btn-act" style="background:var(--accent)">‚å®Ô∏è<span>DIGITAR</span></button>
        <button onclick="reiniciarLeitor()" class="btn-act" style="background:var(--primary)">üîÑ<span>LIMPAR</span></button>
    </div>
</div>

<div id="tab-lista" class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color: var(--primary);">Meu Carrinho</h3>
        <button onclick="resetar()" style="color:var(--danger); background:none; border:none; font-weight:bold; font-size:0.8rem;">Esvaziar</button>
    </div>
    <div id="lista-atual"></div>
    
    <div class="footer-total">
        <span style="font-weight: bold; color: #7f8c8d;">TOTAL</span>
        <b id="total-val" style="font-size: 1.8rem; color: var(--accent);">R$ 0,00</b>
    </div>
</div>

<div id="tab-historico" class="content">
    <h3 style="color: var(--primary);">Comparativo de Pre√ßos</h3>
    <div id="history-data"></div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let scanner;
    let items = JSON.parse(localStorage.getItem('multi_carrinho')) || [];
    let history = JSON.parse(localStorage.getItem('multi_precos')) || {};
    let lastBarcode = "";

    async function init() {
        scanner = new Html5Qrcode("reader");
        render();
        startScanner();
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    function startScanner() {
        const config = { fps: 25, qrbox: { width: 240, height: 100 } };
        scanner.start({ facingMode: "environment" }, config, (text) => {
            if (text !== lastBarcode) {
                lastBarcode = text;
                vibrar(150);
                checkPriceHistory(text);
                // Efeito visual de confirma√ß√£o
                document.getElementById('reader-container').style.borderColor = "var(--accent)";
                setTimeout(() => document.getElementById('reader-container').style.borderColor = "#ddd", 500);
            }
        }).catch(err => console.error(err));
    }

    function checkPriceHistory(barcode) {
        const alertBox = document.getElementById('price-alert');
        if(history[barcode]) {
            let info = history[barcode].map(h => `<br>‚Ä¢ ${h.market}: <b style="color:var(--primary)">R$ ${h.price.toFixed(2)}</b>`).join('');
            alertBox.innerHTML = `üîé <b>Pre√ßos j√° salvos:</b> ${info}`;
            alertBox.style.display = 'block';
        } else {
            alertBox.innerHTML = "üè∑Ô∏è <b>Novo produto!</b> Bata foto do pre√ßo para registrar.";
            alertBox.style.display = 'block';
        }
    }

    async function tirarFotoPreco() {
        const alertBox = document.getElementById('price-alert');
        alertBox.innerHTML = "‚è≥ ANALISANDO PRE√áO...";
        alertBox.style.display = "block";

        const video = document.querySelector('video');
        const canvas = document.getElementById('hidden-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; canvas.height = 320;
        ctx.drawImage(video, video.videoWidth/2 - 320, video.videoHeight/2 - 160, 640, 320, 0, 0, 640, 320);

        try {
            const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'por');
            const match = text.match(/\d+,\d{2}/);
            if (match) {
                addItem(parseFloat(match[0].replace(',', '.')));
            } else {
                alert("N√£o consegui ler o pre√ßo. Tente alinhar o valor grande na mira.");
                entradaManual();
            }
        } catch (e) { entradaManual(); }
    }

    function addItem(price) {
        const market = document.getElementById('current-market').value;
        items.unshift({ id: Date.now(), market, price }); // Adiciona no in√≠cio
        
        if(lastBarcode) {
            if(!history[lastBarcode]) history[lastBarcode] = [];
            let mIdx = history[lastBarcode].findIndex(h => h.market === market);
            if(mIdx > -1) history[lastBarcode][mIdx].price = price;
            else history[lastBarcode].push({ market, price });
        }

        save();
        vibrar([50, 50]);
        document.getElementById('price-alert').innerHTML = "‚úÖ ADICIONADO COM SUCESSO!";
        setTimeout(() => { document.getElementById('price-alert').style.display = 'none'; }, 1500);
    }

    function save() {
        localStorage.setItem('multi_carrinho', JSON.stringify(items));
        localStorage.setItem('multi_precos', JSON.stringify(history));
        render();
    }

    function render() {
        let total = 0;
        document.getElementById('lista-atual').innerHTML = items.map(i => {
            total += i.price;
            return `<div class="card">
                <div><span class="market-tag">${i.market}</span><b style="color:#2c3e50">Item</b></div>
                <div style="display:flex; align-items:center gap:15px;">
                    <b style="font-size:1.1rem">R$ ${i.price.toFixed(2)}</b>
                    <button onclick="remover(${i.id})" style="border:none;background:none;color:var(--danger);font-size:1.5rem;padding-left:15px;">√ó</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('total-val').innerText = "R$ " + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});

        document.getElementById('history-data').innerHTML = Object.keys(history).map(code => {
            let prices = history[code].map(p => `<div style="display:flex; justify-content:space-between; margin-top:5px;"><span>${p.market}</span><b>R$ ${p.price.toFixed(2)}</b></div>`).join('');
            return `<div class="card" style="flex-direction:column; align-items:stretch; border-left:4px solid var(--highlight)">
                <div style="font-size:0.6rem; color:#95a5a6; border-bottom:1px solid #eee; padding-bottom:5px;">C√ìDIGO: ${code}</div>
                ${prices}
            </div>`;
        }).join('');
    }

    function remover(id) { items = items.filter(i => i.id !== id); save(); }
    function resetar() { if(confirm("Deseja limpar todo o carrinho atual?")) { items = []; save(); } }
    function entradaManual() { let p = prompt("Digite o pre√ßo unit√°rio:"); if(p) addItem(parseFloat(p.replace(',','.'))); }
    function vibrar(p) { if(navigator.vibrate) navigator.vibrate(p); }
    function reiniciarLeitor() { lastBarcode = ""; document.getElementById('price-alert').style.display = 'none'; vibrar(50); }

    window.onload = init;
</script>
</body>
</html>

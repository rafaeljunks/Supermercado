<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Caixa Multi-Mercado</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --highlight: #f39c12; --bg: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .market-header { background: var(--primary); color: white; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .market-select { background: #34495e; color: white; border: 1px solid #5d6d7e; padding: 8px; border-radius: 5px; font-weight: bold; width: 100%; font-size: 1rem; }

        .tabs { display: flex; background: #1a252f; color: white; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 0.75rem; opacity: 0.6; font-weight: bold; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--accent); }

        .content { flex: 1; display: none; overflow-y: auto; padding: 10px; }
        .content.active { display: block; }

        #reader-container { position: relative; width: 100%; height: 30vh; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        #reader { width: 100% !important; height: 100% !important; }
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 90px; border: 2px solid var(--highlight); z-index: 10; border-radius: 10px; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); }

        .card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--accent); }
        .item-row { display: flex; justify-content: space-between; align-items: center; }
        .market-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #333; font-weight: bold; margin-right: 8px; }

        #price-alert { background: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin: 10px 0; display: none; font-size: 0.85rem; border-radius: 5px; }

        .footer-total { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 3px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-act { border: none; padding: 12px; border-radius: 8px; color: white; font-weight: bold; font-size: 0.7rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="market-header">
    <select id="current-market" class="market-select">
        <option value="Condor">Condor</option>
        <option value="Hipermais">Hipermais</option>
        <option value="Sams Club">Sams Club</option>
        <option value="Fort Atacadista">Fort Atacadista</option>
        <option value="Angeloni">Angeloni</option>
        <option value="Giassi">Giassi</option>
    </select>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab(0)">ESCANEAMENTO</div>
    <div class="tab" onclick="switchTab(1)">CARRINHO</div>
    <div class="tab" onclick="switchTab(2)">HIST√ìRICO</div>
</div>

<div id="tab-scan" class="content active">
    <div id="reader-container">
        <div id="reader"></div>
        <div class="scan-overlay"></div>
    </div>
    
    <div id="price-alert"></div>

    <div class="btn-group">
        <button onclick="tirarFotoPreco()" class="btn-act" style="background:var(--highlight)">üì∏<span>LER PRE√áO</span></button>
        <button onclick="entradaManual()" class="btn-act" style="background:var(--accent)">‚å®Ô∏è<span>DIGITAR</span></button>
        <button onclick="reiniciarLeitor()" class="btn-act" style="background:var(--primary)">üîÑ<span>REINICIAR</span></button>
    </div>
    <p style="text-align: center; color: #666; font-size: 0.7rem;">Leia o c√≥digo de barras e depois capture o pre√ßo.</p>
</div>

<div id="tab-lista" class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0">Itens no Carrinho</h4>
        <button onclick="resetar()" style="color:red; background:none; border:none; font-size:0.7rem;">Limpar Tudo</button>
    </div>
    <div id="lista-atual"></div>
    
    <div class="footer-total">
        <span>TOTAL</span>
        <b id="total-val" style="font-size: 1.6rem; color: var(--accent);">R$ 0,00</b>
    </div>
</div>

<div id="tab-historico" class="content">
    <h4>üîç Hist√≥rico de Pre√ßos</h4>
    <div id="history-data"></div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    let scanner;
    let items = JSON.parse(localStorage.getItem('multi_carrinho')) || [];
    let history = JSON.parse(localStorage.getItem('multi_precos')) || {};
    let lastBarcode = "";

    async function init() {
        scanner = new Html5Qrcode("reader");
        render();
        startScanner();
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
    }

    function startScanner() {
        const config = { fps: 20, qrbox: { width: 220, height: 90 } };
        scanner.start({ facingMode: "environment" }, config, (text) => {
            if (text !== lastBarcode) {
                lastBarcode = text;
                vibrar(100);
                checkPriceHistory(text);
            }
        }).catch(err => console.error(err));
    }

    function checkPriceHistory(barcode) {
        const alertBox = document.getElementById('price-alert');
        if(history[barcode]) {
            let info = history[barcode].map(h => `<br>‚Ä¢ ${h.market}: <b>R$ ${h.price.toFixed(2)}</b>`).join('');
            alertBox.innerHTML = `üì¢ <b>J√° visto em:</b> ${info}`;
            alertBox.style.display = 'block';
        } else {
            alertBox.innerHTML = "üè∑Ô∏è <b>Novo produto!</b> Capture o pre√ßo para salvar.";
            alertBox.style.display = 'block';
        }
    }

    async function tirarFotoPreco() {
        const alertBox = document.getElementById('price-alert');
        alertBox.innerHTML = "‚è≥ LENDO PRE√áO...";
        alertBox.style.display = "block";

        const video = document.querySelector('video');
        const canvas = document.getElementById('hidden-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; canvas.height = 320;
        ctx.drawImage(video, video.videoWidth/2 - 320, video.videoHeight/2 - 160, 640, 320, 0, 0, 640, 320);

        try {
            const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'por');
            const match = text.match(/\d+,\d{2}/);
            if (match) {
                addItem(parseFloat(match[0].replace(',', '.')));
            } else {
                alert("Pre√ßo n√£o detectado.");
                entradaManual();
            }
        } catch (e) { 
            entradaManual(); 
        }
    }

    function addItem(price) {
        const market = document.getElementById('current-market').value;
        items.push({ id: Date.now(), market, price });
        
        if(lastBarcode) {
            if(!history[lastBarcode]) history[lastBarcode] = [];
            let mIdx = history[lastBarcode].findIndex(h => h.market === market);
            if(mIdx > -1) history[lastBarcode][mIdx].price = price;
            else history[lastBarcode].push({ market, price });
        }

        save();
        vibrar([50, 30, 50]);
        document.getElementById('price-alert').innerHTML = "‚úÖ ADICIONADO!";
        setTimeout(() => { document.getElementById('price-alert').style.display = 'none'; }, 2000);
    }

    function save() {
        localStorage.setItem('multi_carrinho', JSON.stringify(items));
        localStorage.setItem('multi_precos', JSON.stringify(history));
        render();
    }

    function render() {
        let total = 0;
        document.getElementById('lista-atual').innerHTML = items.map(i => {
            total += i.price;
            return `<div class="card item-row">
                <div><span class="market-tag">${i.market}</span><span>Produto</span></div>
                <b>R$ ${i.price.toFixed(2)}</b>
                <button onclick="remover(${i.id})" style="border:none;background:none;color:red;font-size:1.2rem;">√ó</button>
            </div>`;
        }).reverse().join('');
        document.getElementById('total-val').innerText = "R$ " + total.toFixed(2);

        document.getElementById('history-data').innerHTML = Object.keys(history).map(code => {
            let prices = history[code].map(p => `<div>${p.market}: <b>R$ ${p.price.toFixed(2)}</b></div>`).join('');
            return `<div class="card" style="border-left:4px solid var(--highlight)">
                <div style="font-size:0.6rem; color:#999;">C√ìD: ${code}</div>
                ${prices}
            </div>`;
        }).join('');
    }

    function remover(id) { items = items.filter(i => i.id !== id); save(); }
    function resetar() { if(confirm("Esvaziar o carrinho?")) { items = []; save(); } }
    function entradaManual() { let p = prompt("Digite o pre√ßo (ex: 4.99):"); if(p) addItem(parseFloat(p.replace(',','.'))); }
    function vibrar(p) { if(navigator.vibrate) navigator.vibrate(p); }
    function reiniciarLeitor() { if(scanner) scanner.stop().then(() => { lastBarcode = ""; startScanner(); }); }

    window.onload = init;
</script>
</body>
</html>
